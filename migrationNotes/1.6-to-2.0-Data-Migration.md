## Catalog Changes
### Products and Skus
The brunt of these changes are centered around the changes in how `Products` relate to `Sku`s (see [[Main Entities]] for how the relationships work now).  If you had a custom Product subclass, you would normally extend `ProductSkuImpl` since most framework users have the assumption that a Product itself can be sold.  Since this is the most common case, we have removed the `ProductSkuImpl` entity entirely, and pushed the one-to-one relationship from `Product` to `Sku` up to the `ProductImpl` entity, and moved fields that were in `ProductImpl` to`SkuImpl`.

### Using ProductSkuImpl as the main entity
For 1.6.0 and prior, the most common use of the catalog domain was to subclass `ProductSkuImpl`. This is also the entity that the admin had out-of-the-box support for.  In order to move your database tables and migrate your data to the new paradigm, there are a few steps to take to ensure your data ends up in the right place:

1.  **Remove duplicated columns between `BLC_PRODUCT` and `BLC_SKU`** - these were currently being tracked side-by-side as far as the admin is concerned so data should be the same in both tables.
    The following columns have been removed from `BLC_PRODUCT` in favor of their duplicates in `BLC_SKU`:
    ```sql
    `ACTIVE_END_DATE` datetime DEFAULT NULL
    `ACTIVE_START_DATE` datetime DEFAULT NULL
    `DESCRIPTION` varchar(255) DEFAULT NULL
    `LONG_DESCRIPTION` longtext
    `NAME` varchar(255) NOT NULL
    ```
    These are removed from the `BLC_PRODUCT` table with the following SQL:
    ```sql
    ALTER TABLE `BLC_PRODUCT` DROP KEY `PRODUCT_NAME_INDEX`;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN `NAME`;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN `DESCRIPTION`;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN `LONG_DESCRIPTION`;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN `ACTIVE_START_DATE`;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN `ACTIVE_END_DATE`;
    ```

2.  **Move columns that are currently being tracked in `BLC_PRODUCT` to where they are moved to in `BLC_SKU`**
    The following columns have been moved from `BLC_PRODUCT` into `BLC_SKU`:
    ```sql
    `CONTAINER_SHAPE` varchar(255) DEFAULT NULL,
    `DEPTH` decimal(19,2) DEFAULT NULL,
    `DIMENSION_UNIT_OF_MEASURE` varchar(255) DEFAULT NULL,
    `GIRTH` decimal(19,2) DEFAULT NULL,
    `HEIGHT` decimal(19,2) DEFAULT NULL,
    `CONTAINER_SIZE` varchar(255) DEFAULT NULL,
    `WIDTH` decimal(19,2) DEFAULT NULL,
    `IS_MACHINE_SORTABLE` bit(1) DEFAULT NULL,
    `WEIGHT` decimal(19,2) DEFAULT NULL,
    `WEIGHT_UNIT_OF_MEASURE` varchar(255) DEFAULT NULL,
    ```
    To add these to your BLC_SKU table, run the following script:
    ```sql
    ALTER TABLE `BLC_SKU` ADD COLUMN `CONTAINER_SHAPE` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `DEPTH` decimal(19,2) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `DIMENSION_UNIT_OF_MEASURE` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `GIRTH` decimal(19,2) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `HEIGHT` decimal(19,2) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `CONTAINER_SIZE` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `WIDTH` decimal(19,2) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `IS_MACHINE_SORTABLE` bit(1) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `WEIGHT` decimal(19,2) DEFAULT NULL;
    ALTER TABLE `BLC_SKU` ADD COLUMN `WEIGHT_UNIT_OF_MEASURE` varchar(255) DEFAULT NULL;
    ```
    Now you can import the data from those fields in `BLC_PRODUCT`:
    ```sql
    UPDATE `BLC_SKU` AS sku SET sku.CONTAINER_SHAPE=(SELECT product.CONTAINER_SHAPE FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.CONTAINER_SIZE=(SELECT product.CONTAINER_SIZE FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.DEPTH=(SELECT product.DEPTH FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.DIMENSION_UNIT_OF_MEASURE=(SELECT product.DIMENSION_UNIT_OF_MEASURE FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.GIRTH=(SELECT product.GIRTH FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.HEIGHT=(SELECT product.HEIGHT FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.WIDTH=(SELECT product.WIDTH FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.IS_MACHINE_SORTABLE=(SELECT product.IS_MACHINE_SORTABLE FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.WEIGHT=(SELECT product.WEIGHT FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    UPDATE `BLC_SKU` AS sku SET sku.WEIGHT_UNIT_OF_MEASURE=(SELECT product.WEIGHT_UNIT_OF_MEASURE FROM BLC_PRODUCT AS product, BLC_PRODUCT_SKU WHERE BLC_PRODUCT_SKU.SKU_ID = sku.SKU_ID AND product.PRODUCT_ID = BLC_PRODUCT_SKU.PRODUCT_ID);
    ```

3.  **Delete the unnecessary columns from `BLC_PRODUCT`** - now that the data has been moved, no need to keep these around
    ```sql
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN CONTAINER_SHAPE;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN CONTAINER_SIZE;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN DEPTH;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN DIMENSION_UNIT_OF_MEASURE;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN GIRTH;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN HEIGHT;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN WIDTH;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN IS_MACHINE_SORTABLE;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN WEIGHT;
    ALTER TABLE `BLC_PRODUCT` DROP COLUMN WEIGHT_UNIT_OF_MEASURE;
    ```

4.  **Create new columns in `BLC_PRODUCT`**
    ```sql
    ALTER TABLE `BLC_PRODUCT` ADD COLUMN `ARCHIVED` char(1) DEFAULT NULL;
    ALTER TABLE `BLC_PRODUCT` ADD COLUMN `DISPLAY_TEMPLATE` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_PRODUCT` ADD COLUMN `URL` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_PRODUCT` ADD COLUMN `URL_KEY` varchar(255) DEFAULT NULL;
    ALTER TABLE `BLC_PRODUCT` ADD COLUMN `DEFAULT_SKU_ID` bigint(20) NOT NULL;
    ```
5.  **Move the `BLC_PRODUCT_MEDIA_MAP` to be handled at the `Sku` level** - `BLC_PRODUCT_MEDIA_MAP has been deprecated and is maintained at a Product's defaultSku.  To move your data, run the following script:
    ```sql
    INSERT INTO BLC_SKU_MEDIA_MAP (SELECT PRODUCT_SKU.SKU_ID, MEDIA_ID, MAP_KEY FROM BLC_PRODUCT_MEDIA_MAP AS PRODUCT_MEDIA_MAP, BLC_PRODUCT_SKU AS PRODUCT_SKU WHERE PRODUCT_MEDIA_MAP.BLC_PRODUCT_PRODUCT_ID = PRODUCT_SKU.PRODUCT_ID);
    ```

5.  **Populate the `DEFAULT_SKU` column in `BLC_PRODUCT`**
    ```sql
    UPDATE `BLC_PRODUCT` AS product SET `DEFAULT_SKU_ID`=(SELECT `SKU_ID` FROM `BLC_PRODUCT_SKU` WHERE BLC_PRODUCT_SKU.PRODUCT_ID = product.PRODUCT_ID);
    ```

6.  **Add relationship keys for `DEFAULT_SKU_ID`**
    ```sql
    ALTER TABLE `BLC_PRODUCT` ADD CONSTRAINT UNIQUE KEY `DEFAULT_SKU_ID` (`DEFAULT_SKU_ID`);
    ALTER TABLE `BLC_PRODUCT` ADD KEY `FK5B95B7C96D386535` (`DEFAULT_SKU_ID`);
    ALTER TABLE `BLC_PRODUCT` ADD CONSTRAINT `FK5B95B7C96D386535` FOREIGN KEY (`DEFAULT_SKU_ID`) REFERENCES `BLC_SKU` (`SKU_ID`);
    ```

7.  **Change foreign key reference in custom table subclass to reference `BLC_PRODUCT`**
    Assuming that you have a custom subclass of `ProductSkuImpl` (`MyCompanyProductImpl`) that maps to a custom table (`MC_PRODUCT`) that looks like this:
    ```sql
    CREATE TABLE `MC_PRODUCT` (
      `MYCOMPANY_FIELD` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL,
      `PRODUCT_ID` bigint(20) NOT NULL,
      PRIMARY KEY (`PRODUCT_ID`),
      KEY `FK3CBEBADC689F939C` (`PRODUCT_ID`),
      CONSTRAINT `FK3CBEBADC689F939C` FOREIGN KEY (`PRODUCT_ID`) REFERENCES `BLC_PRODUCT_SKU` (`PRODUCT_ID`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
    ```
    You can then drop and recreate the constraint that is on `BLC_PRODUCT_SKU` to instead just reference the `BLC_PRODUCT` table:
    ```sql
    ALTER TABLE `MC_PRODUCT` DROP FOREIGN KEY `FK3CBEBADC689F939C`;
    ALTER TABLE `MC_PRODUCT` ADD CONSTRAINT `FK3CBEBADC689F939C` FOREIGN KEY (`PRODUCT_ID`) REFERENCES `BLC_PRODUCT` (`PRODUCT_ID`);
    ```

## Tax Changes
Taxes have been refactored completely away from `BLC_ORDER` and moved to only being tracked via `BLC_FULFILLMENT_GROUP`. The top-level fields (`COUNTY_TAX`, `STATE_TAX`, etc) have been moved off of `BLC_FULFILLMENT_GROUP` and into a new table, `BLC_TAX_DETAIL`.  `BLC_TAX_DETAIL` records are then related back to `BLC_FULFILLMENT_GROUP` records via `BLC_FG_FG_TAX_REF`.  Since the handling of taxes is somewhat dependent on locale and your business and/or industry, we are not going to prescribe specifically how taxes should be migrated.  However, we will identify table changes and provide some guidelines about how this might be accomplished.
### `BLC_FULFILLMENT_GROUP`
1.  **Add new columns to `BLC_FULFILLMENT_GROUP`**
    ```sql
    ALTER TABLE BLC_FULFILLMENT_GROUP ADD COLUMN `TOTAL_FEE_TAX` decimal(19,5) DEFAULT NULL;
    ALTER TABLE BLC_FULFILLMENT_GROUP ADD COLUMN `TOTAL_FG_TAX` decimal(19,5) DEFAULT NULL;
    ALTER TABLE BLC_FULFILLMENT_GROUP ADD COLUMN `TOTAL_ITEM_TAX` decimal(19,5) DEFAULT NULL;
    ```
2.  **Create a temporary table to hold the tax information:**
    ```sql
    CREATE TABLE `TMP_BLC_TAX_DETAIL` (
      `TAX_DETAIL_ID` bigint(20) NOT NULL AUTO_INCREMENT,
      `AMOUNT` decimal(19,5),
      `TYPE` varchar(255),
      `ORDER_ID` bigint(20) DEFAULT NULL,
      `FULFILLMENT_GROUP_ID` bigint(20) DEFAULT NULL,
      PRIMARY KEY (`TAX_DETAIL_ID`)
    ) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=latin1;
    ```

3.  **Export `BLC_ORDER` and `BLC_FULFILLMENT_GROUP` fields into the temporary table**
    ```sql
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`ORDER_ID`, `AMOUNT`, `TYPE`) SELECT ORDER_ID, COUNTY_TAX, 'COUNTY' FROM BLC_ORDER;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`ORDER_ID`, `AMOUNT`, `TYPE`) SELECT ORDER_ID, CITY_TAX, 'CITY' FROM BLC_ORDER;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`ORDER_ID`, `AMOUNT`, `TYPE`) SELECT ORDER_ID, COUNTRY_TAX, 'COUNTRY' FROM BLC_ORDER;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`ORDER_ID`, `AMOUNT`, `TYPE`) SELECT ORDER_ID, DISTRICT_TAX, 'DISTRICT' FROM BLC_ORDER;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`ORDER_ID`, `AMOUNT`, `TYPE`) SELECT ORDER_ID, STATE_TAX, 'STATE' FROM BLC_ORDER;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`FULFILLMENT_GROUP_ID`, `AMOUNT`, `TYPE`) SELECT FULFILLMENT_GROUP_ID, COUNTY_TAX, 'COUNTY' FROM BLC_FULFILLMENT_GROUP;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`FULFILLMENT_GROUP_ID`, `AMOUNT`, `TYPE`) SELECT FULFILLMENT_GROUP_ID, CITY_TAX, 'CITY' FROM BLC_FULFILLMENT_GROUP;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`FULFILLMENT_GROUP_ID`, `AMOUNT`, `TYPE`) SELECT FULFILLMENT_GROUP_ID, COUNTRY_TAX, 'COUNTRY' FROM BLC_FULFILLMENT_GROUP;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`FULFILLMENT_GROUP_ID`, `AMOUNT`, `TYPE`) SELECT FULFILLMENT_GROUP_ID, DISTRICT_TAX, 'DISTRICT' FROM BLC_FULFILLMENT_GROUP;
    INSERT INTO `TMP_BLC_TAX_DETAIL` (`FULFILLMENT_GROUP_ID`, `AMOUNT`, `TYPE`) SELECT FULFILLMENT_GROUP_ID, STATE_TAX, 'STATE' FROM BLC_FULFILLMENT_GROUP;
    ```
3.  **Export temporary data into `BLC_TAX_DETAIL`**
    _TODO_
4. **Populate the `BLC_FG_FG_TAX_REF` table**
    _TODO_
5. **Drop the temporary table - `DROP TABLE TMP_BLC_TAX_DETAIL;`**

6. **Remove unneeded columns from `BLC_FULFILLMENT_GROUP` and `BLC_ORDER`**
    ```sql
    ALTER TABLE BLC_ORDER DROP COLUMN `CITY_TAX`;
    ALTER TABLE BLC_ORDER DROP COLUMN `COUNTRY_TAX`;
    ALTER TABLE BLC_ORDER DROP COLUMN `COUNTY_TAX`;
    ALTER TABLE BLC_ORDER DROP COLUMN `DISTRICT_TAX`;
    ALTER TABLE BLC_ORDER DROP COLUMN `STATE_TAX`;
    ALTER TABLE BLC_FULFILLMENT_GROUP DROP COLUMN `STATE_TAX`;
    ALTER TABLE BLC_FULFILLMENT_GROUP DROP COLUMN `CITY_TAX`;
    ALTER TABLE BLC_FULFILLMENT_GROUP DROP COLUMN `COUNTRY_TAX`;
    ALTER TABLE BLC_FULFILLMENT_GROUP DROP COLUMN `COUNTY_TAX`;
    ALTER TABLE BLC_FULFILLMENT_GROUP DROP COLUMN `DISTRICT_TAX`;
    ```

## Newly Created Tables
Complete import script is located [[here|sql/broadleaf-2.0-created.sql]]. It is recommended to run these table creation imports before moving on to the next section.

## Other existing table modifications
* `BLC_MEDIA`
    If you have existing data in this table, you will want to move your data to the new columns:
    ```sql
    ## Add new columns
    ALTER TABLE BLC_MEDIA ADD COLUMN `ALT_TEXT` varchar(255) DEFAULT NULL;
    ALTER TABLE BLC_MEDIA ADD COLUMN `TAGS` varchar(255) DEFAULT NULL;
    ALTER TABLE BLC_MEDIA ADD COLUMN `TITLE` varchar(255) DEFAULT NULL;
    ALTER TABLE BLC_MEDIA ADD KEY `MEDIA_TITLE_INDEX` (`TITLE`);
    ## Transfer data from old columns to new
    UPDATE BLC_MEDIA SET `ALT_TEXT` = `LABEL`;
    UPDATE BLC_MEDIA SET `TITLE` = `NAME`;
    ## Remove old columns
    ALTER TABLE BLC_MEDIA DROP COLUMN `LABEL`;
    ALTER TABLE BLC_MEDIA DROP COLUMN `NAME`;
    ALTER TABLE BLC_MEDIA DROP KEY `MEDIA_NAME_INDEX`;
    ```

* The rest of the modifications to existing Broadleaf tables should not require data changes. They are consolidated [[here|sql/broadleaf-2.0-altered.sql]].  This file is intended to be run against an existing 1.6 database.

## Raw Database Dumps
These dumps were generated by starting up test applications with BLC 1.6.0 and 2.0.0 on MySQL 5.5.14 and are included here for further reference
* [[Raw 1.6 Dump|sql/broadleaf-1.6-raw.sql]]
* [[Raw 2.0 Dump|sql/broadleaf-2.0-raw.sql]]