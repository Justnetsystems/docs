# 3.0 to 3.1 Migration Notes

## Data Migration



## Database Changes

There are several DB changes related to the 3.0 to 3.1 upgrade. You can find the history of changes to the database in the [[Database Model]].

Here is an example script of the changes that need to be applied for 3.1.
You can run the following script AT YOUR OWN RISK to update your tables. Please note that this script does DROP tables as this was based off of a Liquibase changelog Database diff. You will need to read the data migration section above and appropriately migrate the data if necessary.

```sql
CREATE TABLE BLC_ADMIN_USER_ADDTL_FIELDS (ADMIN_USER_ID BIGINT(19) NOT NULL, FIELD_VALUE VARCHAR(255) NULL, FIELD_NAME VARCHAR(255) NOT NULL);

CREATE TABLE BLC_CAT_SITE_MAP_GEN_CFG (ENDING_DEPTH INT(10) NOT NULL, STARTING_DEPTH INT(10) NOT NULL, GEN_CONFIG_ID BIGINT(19) NOT NULL, ROOT_CATEGORY_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_CUST_SITE_MAP_GEN_CFG (GEN_CONFIG_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_ORDER_PAYMENT_TRANSACTION (PAYMENT_TRANSACTION_ID BIGINT(19) NOT NULL, TRANSACTION_AMOUNT DECIMAL(19, 2) NULL, ARCHIVED CHAR(1) NULL, CUSTOMER_IP_ADDRESS VARCHAR(255) NULL, DATE_RECORDED datetime NULL, RAW_RESPONSE LONGTEXT NULL, SUCCESS BIT(1) NULL, TRANSACTION_TYPE VARCHAR(255) NULL, ORDER_PAYMENT BIGINT(19) NOT NULL, PARENT_TRANSACTION BIGINT(19) NULL);

CREATE TABLE BLC_SANDBOX_MGMT (SANDBOX_MGMT_ID BIGINT(19) NOT NULL, SANDBOX_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_SITE_MAP_CFG (INDEXED_SITE_MAP_FILE_NAME VARCHAR(255) NULL, INDEXED_SITE_MAP_FILE_PATTERN VARCHAR(255) NULL, MAX_URL_ENTRIES_PER_FILE INT(10) NULL, SITE_MAP_FILE_NAME VARCHAR(255) NULL, MODULE_CONFIG_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_SITE_MAP_GEN_CFG (GEN_CONFIG_ID BIGINT(19) NOT NULL, CHANGE_FREQ VARCHAR(255) NOT NULL, DISABLED BIT(1) NOT NULL, GENERATOR_TYPE VARCHAR(255) NOT NULL, PRIORITY VARCHAR(255) NULL, MODULE_CONFIG_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_SITE_MAP_URL_ENTRY (URL_ENTRY_ID BIGINT(19) NOT NULL, CHANGE_FREQ VARCHAR(255) NOT NULL, LAST_MODIFIED datetime NOT NULL, LOCATION VARCHAR(255) NOT NULL, PRIORITY VARCHAR(255) NOT NULL, GEN_CONFIG_ID BIGINT(19) NOT NULL);

CREATE TABLE BLC_TRANS_ADDITNL_FIELDS (PAYMENT_TRANSACTION_ID BIGINT(19) NOT NULL, FIELD_VALUE LONGTEXT NULL, FIELD_NAME VARCHAR(255) NOT NULL);

ALTER TABLE BLC_ORDER_PAYMENT ADD ARCHIVED CHAR(1) NULL;

ALTER TABLE BLC_CATEGORY_PRODUCT_XREF ADD CATEGORY_PRODUCT_ID BIGINT(19) NOT NULL;

ALTER TABLE BLC_CATEGORY_XREF ADD CATEGORY_XREF_ID BIGINT(19) NOT NULL;

ALTER TABLE BLC_SANDBOX ADD COLOR VARCHAR(255) NULL;

ALTER TABLE BLC_PRODUCT ADD DEFAULT_SKU_ID BIGINT(19) NULL;

ALTER TABLE BLC_SANDBOX ADD DESCRIPTION VARCHAR(255) NULL;

ALTER TABLE BLC_FLD_DEF ADD ENUM_ID BIGINT(19) NULL;

ALTER TABLE BLC_PAGE ADD EXCLUDE_FROM_SITE_MAP BIT(1) NULL;

ALTER TABLE BLC_SYSTEM_PROPERTY ADD FRIENDLY_GROUP VARCHAR(255) NULL;

ALTER TABLE BLC_SYSTEM_PROPERTY ADD FRIENDLY_NAME VARCHAR(255) NULL;

ALTER TABLE BLC_SYSTEM_PROPERTY ADD FRIENDLY_TAB VARCHAR(255) NULL;

ALTER TABLE BLC_ORDER_PAYMENT ADD GATEWAY_TYPE VARCHAR(255) NULL;

ALTER TABLE BLC_SANDBOX ADD GO_LIVE_DATE datetime NULL;

ALTER TABLE BLC_CUSTOMER ADD IS_PREVIEW BIT(1) NULL;

ALTER TABLE BLC_ORDER ADD IS_PREVIEW BIT(1) NULL;

ALTER TABLE BLC_ORDER_PAYMENT ADD ORDER_PAYMENT_ID BIGINT(19) NOT NULL;

ALTER TABLE BLC_PAYMENT_LOG ADD ORDER_PAYMENT_REFERENCE_NUMBER VARCHAR(255) NULL;

ALTER TABLE BLC_ORDER_ITEM ADD PARENT_ORDER_ITEM_ID BIGINT(19) NULL;

ALTER TABLE BLC_SANDBOX ADD PARENT_SANDBOX_ID BIGINT(19) NULL;

ALTER TABLE BLC_PRODUCT_OPTION_XREF ADD PRODUCT_OPTION_XREF_ID BIGINT(19) NOT NULL;

ALTER TABLE BLC_SYSTEM_PROPERTY ADD PROPERTY_TYPE VARCHAR(255) NULL;

ALTER TABLE BLC_FLD_DEF ADD REQUIRED_FLAG BIT(1) NULL;

ALTER TABLE BLC_OFFER ADD REQUIRES_RELATED_TAR_QUAL BIT(1) NULL;

ALTER TABLE BLC_PRODUCT_OPTION ADD VALIDATION_STRATEGY_TYPE VARCHAR(255) NULL;

ALTER TABLE BLC_ORDER_PAYMENT ADD REFERENCE_NUMBER VARCHAR(255) NULL;

ALTER TABLE BLC_SANDBOX_MGMT ADD CONSTRAINT UK4845009FE52B6993 UNIQUE (SANDBOX_ID);

ALTER TABLE BLC_ADMIN_USER_ADDTL_FIELDS ADD PRIMARY KEY (ADMIN_USER_ID, FIELD_NAME);

ALTER TABLE BLC_CAT_SITE_MAP_GEN_CFG ADD PRIMARY KEY (GEN_CONFIG_ID);

ALTER TABLE BLC_CUST_SITE_MAP_GEN_CFG ADD PRIMARY KEY (GEN_CONFIG_ID);

ALTER TABLE BLC_ORDER_PAYMENT_TRANSACTION ADD PRIMARY KEY (PAYMENT_TRANSACTION_ID);

ALTER TABLE BLC_PRODUCT_OPTION_XREF ADD PRIMARY KEY (PRODUCT_OPTION_XREF_ID);

ALTER TABLE BLC_SANDBOX_MGMT ADD PRIMARY KEY (SANDBOX_MGMT_ID);

ALTER TABLE BLC_SITE_MAP_CFG ADD PRIMARY KEY (MODULE_CONFIG_ID);

ALTER TABLE BLC_SITE_MAP_GEN_CFG ADD PRIMARY KEY (GEN_CONFIG_ID);

ALTER TABLE BLC_SITE_MAP_URL_ENTRY ADD PRIMARY KEY (URL_ENTRY_ID);

ALTER TABLE BLC_TRANS_ADDITNL_FIELDS ADD PRIMARY KEY (PAYMENT_TRANSACTION_ID, FIELD_NAME);

ALTER TABLE BLC_CAT_SITE_MAP_GEN_CFG ADD CONSTRAINT FK1BA4E695C5F3D60 FOREIGN KEY (ROOT_CATEGORY_ID) REFERENCES BLC_CATEGORY (CATEGORY_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_CAT_SITE_MAP_GEN_CFG ADD CONSTRAINT FK1BA4E69BCAB9F56 FOREIGN KEY (GEN_CONFIG_ID) REFERENCES BLC_SITE_MAP_GEN_CFG (GEN_CONFIG_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_SITE_MAP_GEN_CFG ADD CONSTRAINT FK1D76000A340ED71 FOREIGN KEY (MODULE_CONFIG_ID) REFERENCES BLC_SITE_MAP_CFG (MODULE_CONFIG_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_TRANS_ADDITNL_FIELDS ADD CONSTRAINT FK376DDE4B9E955B1D FOREIGN KEY (PAYMENT_TRANSACTION_ID) REFERENCES BLC_ORDER_PAYMENT_TRANSACTION (PAYMENT_TRANSACTION_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_FLD_DEF ADD CONSTRAINT FK3FCB575E38D08AB5 FOREIGN KEY (ENUM_ID) REFERENCES BLC_DATA_DRVN_ENUM (ENUM_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_SANDBOX_MGMT ADD CONSTRAINT FK4845009F579FE59D FOREIGN KEY (SANDBOX_ID) REFERENCES BLC_SANDBOX (SANDBOX_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_PRODUCT ADD CONSTRAINT FK5B95B7C96D386535 FOREIGN KEY (DEFAULT_SKU_ID) REFERENCES BLC_SKU (SKU_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_CUST_SITE_MAP_GEN_CFG ADD CONSTRAINT FK67C0DBA0BCAB9F56 FOREIGN KEY (GEN_CONFIG_ID) REFERENCES BLC_SITE_MAP_GEN_CFG (GEN_CONFIG_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_SITE_MAP_CFG ADD CONSTRAINT FK7012930FC50D449 FOREIGN KEY (MODULE_CONFIG_ID) REFERENCES BLC_MODULE_CONFIGURATION (MODULE_CONFIG_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_ADMIN_USER_ADDTL_FIELDS ADD CONSTRAINT FK73274CDD46EBC38 FOREIGN KEY (ADMIN_USER_ID) REFERENCES BLC_ADMIN_USER (ADMIN_USER_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_ORDER_PAYMENT_TRANSACTION ADD CONSTRAINT FK86FDE7CE6A69DD9D FOREIGN KEY (ORDER_PAYMENT) REFERENCES BLC_ORDER_PAYMENT (ORDER_PAYMENT_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_ORDER_PAYMENT_TRANSACTION ADD CONSTRAINT FK86FDE7CEE1B66C71 FOREIGN KEY (PARENT_TRANSACTION) REFERENCES BLC_ORDER_PAYMENT_TRANSACTION (PAYMENT_TRANSACTION_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_ORDER_ITEM ADD CONSTRAINT FK9A2E704AB0B0D00A FOREIGN KEY (PARENT_ORDER_ITEM_ID) REFERENCES BLC_ORDER_ITEM (ORDER_ITEM_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_SANDBOX ADD CONSTRAINT FKDD37A9A174160452 FOREIGN KEY (PARENT_SANDBOX_ID) REFERENCES BLC_SANDBOX (SANDBOX_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE BLC_SITE_MAP_URL_ENTRY ADD CONSTRAINT FKE2004FED36AFE1EE FOREIGN KEY (GEN_CONFIG_ID) REFERENCES BLC_CUST_SITE_MAP_GEN_CFG (GEN_CONFIG_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE INDEX ORDERPAYMENT_REFERENCE_INDEX ON BLC_ORDER_PAYMENT(REFERENCE_NUMBER);

CREATE INDEX PAYMENTLOG_REFERENCE_INDEX ON BLC_PAYMENT_LOG(ORDER_PAYMENT_REFERENCE_NUMBER);

CREATE UNIQUE INDEX `PRIMARY` ON BLC_CATEGORY_PRODUCT_XREF(CATEGORY_PRODUCT_ID);

CREATE UNIQUE INDEX `PRIMARY` ON BLC_CATEGORY_XREF(CATEGORY_XREF_ID);

CREATE UNIQUE INDEX `PRIMARY` ON BLC_ORDER_PAYMENT(ORDER_PAYMENT_ID);

ALTER TABLE BLC_FLD_DEF DROP FOREIGN KEY FK3FCB575EFD2EA299;

ALTER TABLE BLC_SC_FLD DROP FOREIGN KEY FK621D7B9513D95585;

ALTER TABLE BLC_ORDER_PAYMENT_DETAILS DROP FOREIGN KEY FK6D3907323E2FC4F9;

ALTER TABLE BLC_ORDER_PAYMENT_DETAILS DROP FOREIGN KEY FK6D390732CE00A2EB;

ALTER TABLE BLC_SC DROP FOREIGN KEY FK74EEB716579FE59D;

ALTER TABLE BLC_SC DROP FOREIGN KEY FK74EEB716F9C4A5B;

ALTER TABLE BLC_PAYMENT_RESPONSE_ITEM DROP FOREIGN KEY FK807B8F323E2FC4F9;

ALTER TABLE BLC_PAYMENT_RESPONSE_ITEM DROP FOREIGN KEY FK807B8F327470F437;

ALTER TABLE BLC_PAYMENT_RESPONSE_ITEM DROP FOREIGN KEY FK807B8F32BE7DFC59;

ALTER TABLE BLC_PAGE_FLD DROP FOREIGN KEY FK86433AD4883C2667;

ALTER TABLE BLC_ORDER_PAYMENT DROP FOREIGN KEY FK9517A14FCA0B98E0;

ALTER TABLE BLC_ORDER_PAYMENT DROP FOREIGN KEY FK9517A14FD894CB5D;

ALTER TABLE BLC_STATIC_ASSET DROP FOREIGN KEY FK9875FB05579FE59D;

ALTER TABLE BLC_STATIC_ASSET DROP FOREIGN KEY FK9875FB05F9C4A5B;

ALTER TABLE BLC_SITE_SANDBOX DROP FOREIGN KEY FKAD4F7EF5579FE59D;

ALTER TABLE BLC_SITE_SANDBOX DROP FOREIGN KEY FKAD4F7EF5843A8B63;

ALTER TABLE SANDBOX_ITEM_ACTION DROP FOREIGN KEY FKB270D74A9797A024;

ALTER TABLE SANDBOX_ITEM_ACTION DROP FOREIGN KEY FKB270D74AFE239304;

ALTER TABLE BLC_AMOUNT_ITEM DROP FOREIGN KEY FKB98530944BC71D98;

ALTER TABLE BLC_PAYMENT_ADDITIONAL_FIELDS DROP FOREIGN KEY FKE3507032D956B1CC;

ALTER TABLE BLC_PAGE DROP FOREIGN KEY FKF41BEDD5579FE59D;

ALTER TABLE BLC_PAGE DROP FOREIGN KEY FKF41BEDD5F9C4A5B;

ALTER TABLE BLC_SITE DROP FOREIGN KEY FKF41D6A8D64EBCCE3;

ALTER TABLE BLC_PAYINFO_ADDITIONAL_FIELDS DROP FOREIGN KEY FKF9378B824BC71D98;

ALTER TABLE BLC_SYSTEM_PROPERTY DROP KEY PROPERTY_NAME_;

ALTER TABLE BLC_ORDER_PAYMENT DROP KEY UK9517A14FD790DEBD;

ALTER TABLE BLC_CUSTOMER DROP KEY key1;

DROP TABLE BLC_AMOUNT_ITEM;

DROP TABLE BLC_ORDER_PAYMENT_DETAILS;

DROP TABLE BLC_PAYINFO_ADDITIONAL_FIELDS;

DROP TABLE BLC_PAYMENT_ADDITIONAL_FIELDS;

DROP TABLE BLC_PAYMENT_RESPONSE_ITEM;

DROP TABLE BLC_SANDBOX_ACTION;

DROP TABLE BLC_SANDBOX_ITEM;

DROP TABLE BLC_SITE_SANDBOX;

DROP TABLE SANDBOX_ITEM_ACTION;

ALTER TABLE BLC_PAGE DROP COLUMN ARCHIVED_FLAG;

ALTER TABLE BLC_SC DROP COLUMN ARCHIVED_FLAG;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN ARCHIVED_FLAG;

ALTER TABLE BLC_ORDER_PAYMENT DROP COLUMN CUSTOMER_IP_ADDRESS;

ALTER TABLE BLC_ORDER_PAYMENT DROP COLUMN CUSTOMER_PAYMENT_ID;

ALTER TABLE BLC_PAGE DROP COLUMN DELETED_FLAG;

ALTER TABLE BLC_SC DROP COLUMN DELETED_FLAG;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN DELETED_FLAG;

ALTER TABLE BLC_FLD_DEF DROP COLUMN FLD_ENUM_ID;

ALTER TABLE BLC_PAGE DROP COLUMN LOCKED_FLAG;

ALTER TABLE BLC_SC DROP COLUMN LOCKED_FLAG;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN LOCKED_FLAG;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN ORIG_ASSET_ID;

ALTER TABLE BLC_SC DROP COLUMN ORIG_ITEM_ID;

ALTER TABLE BLC_PAGE DROP COLUMN ORIG_PAGE_ID;

ALTER TABLE BLC_PAGE DROP COLUMN ORIG_SANDBOX_ID;

ALTER TABLE BLC_SC DROP COLUMN ORIG_SANDBOX_ID;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN ORIG_SANDBOX_ID;

ALTER TABLE BLC_PAGE_FLD DROP COLUMN PAGE_ID;

ALTER TABLE BLC_ORDER_PAYMENT DROP COLUMN PAYMENT_ID;

ALTER TABLE BLC_PAYMENT_LOG DROP COLUMN PAYMENT_INFO_REFERENCE_NUMBER;

ALTER TABLE BLC_ORDER_PAYMENT DROP COLUMN PHONE_ID;

ALTER TABLE BLC_SITE DROP COLUMN PRODUCTION_SANDBOX_ID;

ALTER TABLE BLC_ORDER_PAYMENT DROP COLUMN REFERENCE_NUMBER;

ALTER TABLE BLC_PAGE DROP COLUMN SANDBOX_ID;

ALTER TABLE BLC_SC DROP COLUMN SANDBOX_ID;

ALTER TABLE BLC_STATIC_ASSET DROP COLUMN SANDBOX_ID;

ALTER TABLE BLC_SC_FLD DROP COLUMN SC_ID;

ALTER TABLE BLC_PRODUCT DROP COLUMN TAX_CODE;

DROP INDEX ASST_ARCHVD_FLG_INDX ON BLC_STATIC_ASSET;

DROP INDEX ASST_DLTD_FLG_INDX ON BLC_STATIC_ASSET;

DROP INDEX ASST_LCKD_FLG_INDX ON BLC_STATIC_ASSET;

DROP INDEX ORIG_ASSET_ID_INDX ON BLC_STATIC_ASSET;

DROP INDEX ORIG_PAGE_ID_INDX ON BLC_PAGE;

DROP INDEX PAGE_ARCHVD_FLG_INDX ON BLC_PAGE;

DROP INDEX PAGE_DLTD_FLG_INDX ON BLC_PAGE;

DROP INDEX PAGE_LCKD_FLG_INDX ON BLC_PAGE;

DROP INDEX PAYMENTLOG_REFERENCE_INDEX ON BLC_PAYMENT_LOG;

DROP INDEX `PRIMARY` ON BLC_CATEGORY_PRODUCT_XREF;

DROP INDEX `PRIMARY` ON BLC_CATEGORY_XREF;

DROP INDEX `PRIMARY` ON BLC_ORDER_PAYMENT;

DROP INDEX SC_ARCHVD_FLG_INDX ON BLC_SC;

DROP INDEX SC_DLTD_FLG_INDX ON BLC_SC;

DROP INDEX SC_LCKD_FLG_INDX ON BLC_SC;

DROP INDEX SC_ORIG_ITEM_ID_INDEX ON BLC_SC;

DROP INDEX STORE_CITY_INDEX ON BLC_STORE;

DROP INDEX STORE_COUNTRY_INDEX ON BLC_STORE;

DROP INDEX STORE_LATITUDE_INDEX ON BLC_STORE;

DROP INDEX STORE_LONGITUDE_INDEX ON BLC_STORE;

DROP INDEX STORE_NAME_INDEX ON BLC_STORE;

DROP INDEX STORE_STATE_INDEX ON BLC_STORE;

DROP INDEX STORE_ZIP_INDEX ON BLC_STORE;

ALTER TABLE BLC_CATEGORY_PRODUCT_XREF MODIFY DISPLAY_ORDER DECIMAL(10, 6);

ALTER TABLE BLC_CATEGORY_XREF MODIFY DISPLAY_ORDER DECIMAL(10, 6);

ALTER TABLE BLC_CAT_SEARCH_FACET_XREF MODIFY SEQUENCE DECIMAL(19, 2);

ALTER TABLE BLC_PRODUCT_CROSS_SALE MODIFY SEQUENCE DECIMAL(10, 6);

ALTER TABLE BLC_PRODUCT_FEATURED MODIFY SEQUENCE DECIMAL(10, 6);

ALTER TABLE BLC_PRODUCT_UP_SALE MODIFY SEQUENCE DECIMAL(10, 6);

ALTER TABLE BLC_STORE MODIFY STORE_ID BIGINT(19);

ALTER TABLE BLC_STORE MODIFY STORE_NAME VARCHAR(255) NOT NULL;

ALTER TABLE BLC_ADMIN_SECTION MODIFY USE_DEFAULT_HANDLER BIT(1) NULL;

ALTER TABLE BLC_CATEGORY_PRODUCT_XREF DROP PRIMARY KEY;

ALTER TABLE BLC_CATEGORY_PRODUCT_XREF ADD PRIMARY KEY (CATEGORY_PRODUCT_ID);

ALTER TABLE BLC_CATEGORY_XREF DROP PRIMARY KEY;

ALTER TABLE BLC_CATEGORY_XREF ADD PRIMARY KEY (CATEGORY_XREF_ID);

ALTER TABLE BLC_ORDER_PAYMENT DROP PRIMARY KEY;

ALTER TABLE BLC_ORDER_PAYMENT ADD PRIMARY KEY (ORDER_PAYMENT_ID);

```

Optionally, if you are using Liquibase, here is a DB changelog file that was generated that compares a 3.0.x schema to a 3.1.x schema. If you aren't using Liquibase, please consider using it and see our tutorial for more details: [[Managing DB Versions Migrations With Liquibase]]



